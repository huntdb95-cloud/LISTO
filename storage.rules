rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Helper function: Check if user is authenticated and owns the path
    function isOwner() {
      return request.auth != null && request.auth.uid != null;
    }
    
    function isOwnerPath(userId) {
      return isOwner() && request.auth.uid == userId;
    }

    // ========== Profile Images ==========
    
    // Profile logo: users/{uid}/profile/logo_*
    match /users/{userId}/profile/{fileName} {
      allow read: if isOwnerPath(userId) 
        && fileName.matches('logo_.*');
      allow write: if isOwnerPath(userId)
        && request.resource.size < 5 * 1024 * 1024  // 5MB max
        && request.resource.contentType.matches('image/.*')
        && fileName.matches('logo_.*');
      allow delete: if isOwnerPath(userId)
        && fileName.matches('logo_.*');
    }

    // ========== COI Documents ==========
    
    // Certificate of Insurance: users/{uid}/coi/*
    match /users/{userId}/coi/{fileName} {
      allow read: if isOwnerPath(userId);
      allow write: if isOwnerPath(userId)
        && request.resource.size < 10 * 1024 * 1024  // 10MB max
        && (request.resource.contentType.matches('application/pdf') ||
            request.resource.contentType.matches('image/.*'));
      allow delete: if isOwnerPath(userId);
    }

    // ========== Audit Documents ==========
    
    // Audit documents: users/{uid}/audit/* (legacy path for backward compatibility)
    match /users/{userId}/audit/{fileName} {
      allow read: if isOwnerPath(userId);
      allow write: if isOwnerPath(userId)
        && request.resource.size < 10 * 1024 * 1024  // 10MB max
        && (request.resource.contentType.matches('application/pdf') ||
            request.resource.contentType.matches('image/.*') ||
            request.resource.contentType.matches('application/octet-stream'));
      allow delete: if isOwnerPath(userId);
    }

    // Audit COI files: audits/{uid}/coi/*
    match /audits/{userId}/coi/{fileName} {
      allow read: if isOwnerPath(userId);
      allow write: if isOwnerPath(userId)
        && request.resource.size < 10 * 1024 * 1024  // 10MB max
        && (request.resource.contentType.matches('application/pdf') ||
            request.resource.contentType.matches('image/.*'));
      allow delete: if isOwnerPath(userId);
    }

    // ========== Document Translator ==========
    
    // Document Translator uploads: uploads/{uid}/contract-scanner/*
    match /uploads/{userId}/contract-scanner/{fileName} {
      allow read: if isOwnerPath(userId);
      
      allow write: if isOwnerPath(userId)
        && request.resource.size < 20 * 1024 * 1024  // 20MB max
        && (request.resource.contentType.matches('application/pdf') ||
            request.resource.contentType.matches('image/.*'));
      
      allow delete: if isOwnerPath(userId);
    }
    
    // OCR output files (read-only for users, write-only for Cloud Functions via Admin SDK)
    match /ocr-output/{userId}/{allPaths=**} {
      allow read: if isOwnerPath(userId);
      // Write is handled by Cloud Functions using Admin SDK (bypasses rules)
    }
    
    // ========== Business License ==========
    
    // Business License: users/{uid}/businessLicense/*
    match /users/{userId}/businessLicense/{fileName} {
      allow read: if isOwnerPath(userId);
      allow write: if isOwnerPath(userId)
        && request.resource.size < 10 * 1024 * 1024  // 10MB max
        && (request.resource.contentType.matches('application/pdf') ||
            request.resource.contentType.matches('image/.*'));
      allow delete: if isOwnerPath(userId);
    }

    // ========== Workers Compensation Exemption ==========
    
    // Workers Comp Exemption: users/{uid}/workersComp/*
    match /users/{userId}/workersComp/{fileName} {
      allow read: if isOwnerPath(userId);
      allow write: if isOwnerPath(userId)
        && request.resource.size < 10 * 1024 * 1024  // 10MB max
        && (request.resource.contentType.matches('application/pdf') ||
            request.resource.contentType.matches('image/.*'));
      allow delete: if isOwnerPath(userId);
    }

    // ========== Contract Files ==========
    
    // Contract scanner files: users/{uid}/contracts/* (legacy - for contract scanner)
    match /users/{userId}/contracts/{fileName} {
      allow read: if isOwnerPath(userId);
      allow write: if isOwnerPath(userId)
        && request.resource.size < 20 * 1024 * 1024  // 20MB max (for PDFs, images, HEIC)
        && (request.resource.contentType.matches('application/pdf') ||
            request.resource.contentType.matches('image/.*') ||
            request.resource.contentType.matches('application/octet-stream'));
      allow delete: if isOwnerPath(userId);
    }

    // Builder contract documents: users/{uid}/contracts/{contractId}/builderCoi/*
    match /users/{userId}/contracts/{contractId}/builderCoi/{fileName} {
      allow read: if isOwnerPath(userId);
      allow write: if isOwnerPath(userId)
        && request.resource.size < 10 * 1024 * 1024  // 10MB max
        && (request.resource.contentType.matches('application/pdf') ||
            request.resource.contentType.matches('image/.*'));
      allow delete: if isOwnerPath(userId);
    }

    // Builder subagreement: users/{uid}/contracts/{contractId}/subAgreement/*
    match /users/{userId}/contracts/{contractId}/subAgreement/{fileName} {
      allow read: if isOwnerPath(userId);
      allow write: if isOwnerPath(userId)
        && request.resource.size < 10 * 1024 * 1024  // 10MB max
        && (request.resource.contentType.matches('application/pdf') ||
            request.resource.contentType.matches('image/.*'));
      allow delete: if isOwnerPath(userId);
    }

    // Project COI: users/{uid}/contracts/{contractId}/jobs/{jobId}/projectCoi/*
    match /users/{userId}/contracts/{contractId}/jobs/{jobId}/projectCoi/{fileName} {
      allow read: if isOwnerPath(userId);
      allow write: if isOwnerPath(userId)
        && request.resource.size < 10 * 1024 * 1024  // 10MB max
        && (request.resource.contentType.matches('application/pdf') ||
            request.resource.contentType.matches('image/.*'));
      allow delete: if isOwnerPath(userId);
    }

    // ========== Employee Documents ==========
    
    // Employee W9: users/{uid}/employees/{employeeId}/w9/*
    match /users/{userId}/employees/{employeeId}/w9/{fileName} {
      allow read: if isOwnerPath(userId);
      allow write: if isOwnerPath(userId)
        && request.resource.size < 10 * 1024 * 1024  // 10MB max
        && (request.resource.contentType.matches('application/pdf') ||
            request.resource.contentType.matches('image/.*'));
      allow delete: if isOwnerPath(userId);
    }

    // Employee COI: users/{uid}/employees/{employeeId}/coi/*
    match /users/{userId}/employees/{employeeId}/coi/{fileName} {
      allow read: if isOwnerPath(userId);
      allow write: if isOwnerPath(userId)
        && request.resource.size < 10 * 1024 * 1024  // 10MB max
        && (request.resource.contentType.matches('application/pdf') ||
            request.resource.contentType.matches('image/.*'));
      allow delete: if isOwnerPath(userId);
    }

    // Employee Workers Comp: users/{uid}/employees/{employeeId}/workersComp/*
    match /users/{userId}/employees/{employeeId}/workersComp/{fileName} {
      allow read: if isOwnerPath(userId);
      allow write: if isOwnerPath(userId)
        && request.resource.size < 10 * 1024 * 1024  // 10MB max
        && (request.resource.contentType.matches('application/pdf') ||
            request.resource.contentType.matches('image/.*'));
      allow delete: if isOwnerPath(userId);
    }

    // ========== Laborer Documents (1099 Bookkeeping) ==========
    
    // Laborer W-9: users/{uid}/laborers/{laborerId}/documents/w9/*
    match /users/{userId}/laborers/{laborerId}/documents/w9/{fileName} {
      allow read: if isOwnerPath(userId);
      allow write: if isOwnerPath(userId)
        && request.resource.size < 15 * 1024 * 1024  // 15MB max
        && (request.resource.contentType.matches('application/pdf') ||
            request.resource.contentType.matches('image/.*'));
      allow delete: if isOwnerPath(userId);
    }

    // Laborer COI: users/{uid}/laborers/{laborerId}/documents/coi/*
    match /users/{userId}/laborers/{laborerId}/documents/coi/{fileName} {
      allow read: if isOwnerPath(userId);
      allow write: if isOwnerPath(userId)
        && request.resource.size < 15 * 1024 * 1024  // 15MB max
        && (request.resource.contentType.matches('application/pdf') ||
            request.resource.contentType.matches('image/.*'));
      allow delete: if isOwnerPath(userId);
    }

    // ========== Tax Forms ==========
    
    // Generated 1099-NEC PDFs: users/{uid}/taxForms/1099nec/{taxYear}/*
    match /users/{userId}/taxForms/1099nec/{taxYear}/{fileName} {
      allow read: if isOwnerPath(userId);
      allow write: if isOwnerPath(userId)
        && request.resource.size < 5 * 1024 * 1024  // 5MB max
        && request.resource.contentType.matches('application/pdf');
      allow delete: if isOwnerPath(userId);
    }

    // ========== Default Deny ==========
    
    // Deny all other paths
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

